# 包文档生成指令模板

## 使用方法

将下面的指令复制后，替换 `{PACKAGE_NAME}` 为目标包名（如 index、wal、shard 等），然后发送给 AI。

---

## 指令内容

```
这是一个关于 nostr 的 event 存储项目，请阅读并深入分析 {PACKAGE_NAME} 包的源代码，然后帮我生成两份完整的技术文档：

1. 英文版：docs/{PACKAGE_NAME}.md
2. 中文版：docs/cn/{PACKAGE_NAME}_cn.md

## 参考标准

请参考已完成的 storage 包文档作为标准：
- docs/storage.md (英文版)
- docs/cn/storage_cn.md (中文版)

## 文档要求

### 1. 目标读者
- 主要面向：开发者和架构师
- 次要面向：系统维护者

### 2. 文档结构

文档应包含以下章节（根据包的特性调整）：

#### 必需章节：
1. **概述 (Overview)**
   - 包的职责和核心价值
   - 关键特性表格
   - 与其他包的关系

2. **架构与设计理念 (Architecture and Design Philosophy)**
   - 系统设计原则
   - 依赖关系图
   - 设计层次/模块划分

3. **核心数据结构 (Core Data Structures)**
   - 主要结构体定义
   - 字段说明和用途
   - 二进制布局（如适用）
   - 关键常量和枚举

4. **接口定义 (Interface Definitions)**
   - 所有导出接口
   - 方法签名和语义
   - 实现类说明
   - 并发保证

5. **核心模块详解 (Core Modules)**
   - 每个主要模块一个子章节
   - 模块职责
   - 关键算法（伪码或流程图）
   - 实现细节
   - 边界情况处理

6. **核心工作流 (Core Workflows)**
   - 主要操作的完整流程
   - 时序图或流程图
   - 性能时间估计
   - 错误处理路径

7. **设计决策与权衡 (Design Decisions and Tradeoffs)**
   - 每个关键决策一个子节
   - 决策内容
   - 优势 vs 成本对比表
   - 选择理由

8. **性能分析 (Performance Analysis)**
   - 复杂度分析表
   - 典型延迟估计
   - 内存占用分析
   - 吞吐量估计
   - 性能瓶颈识别

9. **故障排查与调试 (Troubleshooting and Debugging)**
   - 常见问题及症状
   - 原因分析
   - 调试步骤（带代码示例）
   - 解决方案
   - 调试函数/工具参考
   - 日志启用方法

10. **API 快速参考 (API Quick Reference)**
    - 主要函数/方法速查
    - 使用示例
    - 关键常量
    - 错误类型列表

11. **结论 (Conclusion)**
    - 核心价值总结
    - 关键特性回顾
    - 维护者指南要点

#### 可选章节（根据包特性）：
- **并发模型** (如果并发是核心特性)
- **持久化格式** (如果涉及文件格式)
- **索引结构** (如果是索引相关)
- **恢复机制** (如果有崩溃恢复)
- **压缩策略** (如果有数据压缩)
- **配置选项** (如果有丰富配置)

### 3. 内容深度要求

#### 代码分析深度：
- ✅ 阅读所有源文件
- ✅ 理解每个导出类型和函数
- ✅ 识别关键内部函数
- ✅ 分析算法复杂度
- ✅ 理解并发控制机制
- ✅ 识别错误处理路径

#### 文档质量标准：
- ✅ 使用清晰的技术术语
- ✅ 提供具体代码示例（基于实际代码）
- ✅ 包含图表说明（ASCII art 或 Markdown 表格）
- ✅ 标注性能复杂度（Big-O）
- ✅ 说明边界条件和限制
- ✅ 提供实际数值估计（延迟、内存等）
- ✅ 包含故障场景及解决方案
- ✅ 代码引用使用 Markdown 链接到源文件

#### 示例质量：
- 代码片段应从实际源代码提取
- 算法描述应匹配实现
- 流程图应准确反映代码逻辑
- 复杂度分析应基于实际实现

### 4. 格式要求

#### Markdown 格式：
- 使用清晰的标题层级（# ## ### ####）
- 代码块使用语言标识：```go, ```bash, ```
- 表格对齐美观
- 适当使用列表（有序/无序）
- 使用 > 引用重要说明

#### 文件引用：
- 使用相对路径链接源文件
- 格式：`[filename.go](../src/{PACKAGE_NAME}/filename.go)`
- 可链接到特定行：`[function](../src/{PACKAGE_NAME}/file.go#L100)`

#### 代码示例：
```go
// 真实代码片段，不是伪码
type Example struct {
    Field1 string
    Field2 int
}
```

#### 流程图：
使用 ASCII art 或文本流程图：
```
操作1
  ↓
判断条件
  ├─ 是 → 路径A
  └─ 否 → 路径B
```

#### 表格：
```markdown
| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 值1 | 值2 | 值3 |
```

### 5. 两语言版本要求

#### 英文版 (docs/{PACKAGE_NAME}.md)：
- 专业技术英语
- 简洁清晰
- 避免口语化表达
- 技术术语使用标准翻译

#### 中文版 (docs/cn/{PACKAGE_NAME}_cn.md)：
- 准确翻译，保持技术精度
- 保留英文专业术语（如 RWMutex、WAL）
- 代码和命令保持英文
- 注释和说明使用中文

### 6. 元信息

每份文档开头应包含：
```markdown
# {Package Name} 包设计与实现指南

**目标读者:** 开发者、架构师和维护者  
**最后更新:** {当前日期}  
**语言:** 英文/中文

## 目录
[自动生成的目录链接]
```

结尾应包含：
```markdown
---

**文档版本:** v1.0 | 生成: {日期}  
**目标代码:** `src/{PACKAGE_NAME}/` 包
```

## 工作流程

1. **研究阶段：**
   - 使用 semantic_search, grep_search, read_file 等工具
   - 阅读所有 .go 文件
   - 理解包的依赖关系
   - 识别关键数据流

2. **分析阶段：**
   - 提取核心数据结构
   - 分析算法复杂度
   - 识别设计模式
   - 理解并发机制

3. **编写阶段：**
   - 先创建英文版框架
   - 逐章节完善内容
   - 添加代码示例和图表
   - 完成英文版后翻译为中文版

4. **质量检查：**
   - 验证代码引用准确性
   - 检查复杂度分析正确性
   - 确认示例代码可运行性
   - 核对技术术语一致性

## 示例对比

请确保生成的文档与 storage 包文档质量相当：
- 深度：类似的技术深度和细节
- 广度：覆盖所有关键方面
- 实用性：包含可操作的调试和优化建议
- 准确性：基于实际源代码，不臆测

## 特殊注意事项

根据不同包的特点调整：

### 对于索引包 (index)：
- 重点：B-tree 结构、索引算法、查询优化
- 增加：索引格式、查询流程、性能调优

### 对于 WAL 包 (wal)：
- 重点：日志格式、崩溃恢复、写入保证
- 增加：持久化保证、恢复流程、检查点机制

### 对于分片包 (shard)：
- 重点：分片策略、负载均衡、路由算法
- 增加：分片分配、迁移策略、一致性保证

### 对于查询包 (query)：
- 重点：查询解析、执行计划、过滤优化
- 增加：查询语法、优化器、执行流程

### 对于恢复包 (recovery)：
- 重点：恢复流程、数据验证、一致性检查
- 增加：故障检测、修复策略、验证算法

## 输出

请直接创建两个文件，无需额外询问：
1. docs/{PACKAGE_NAME}.md (英文版)
2. docs/cn/{PACKAGE_NAME}_cn.md (中文版)

确保两份文档内容完整、准确、实用。
```

---

## 快速使用示例

### 为 index 包生成文档：
```
这是一个关于 nostr 的 event 存储项目，请阅读并深入分析 index 包的源代码，然后帮我生成两份完整的技术文档：

1. 英文版：docs/index.md
2. 中文版：docs/cn/index_cn.md

请参考已完成的 storage 包文档作为标准（docs/storage.md 和 docs/cn/storage_cn.md），确保文档质量、深度和格式与其保持一致。

[后续按照上述完整指令的要求]
```

### 为 wal 包生成文档：
```
这是一个关于 nostr 的 event 存储项目，请阅读并深入分析 wal 包的源代码，然后帮我生成两份完整的技术文档：

1. 英文版：docs/wal.md
2. 中文版：docs/cn/wal_cn.md

请参考已完成的 storage 包文档作为标准（docs/storage.md 和 docs/cn/storage_cn.md），确保文档质量、深度和格式与其保持一致。

[后续按照上述完整指令的要求]
```

---

## 注意事项

1. **每次只为一个包生成文档**，确保质量
2. **生成前先让 AI 充分研究代码**，避免臆测
3. **验证生成的文档准确性**，对比源代码
4. **根据实际反馈迭代改进**指令模板
5. **保存成功的生成会话**作为未来参考

## 文档生成优先级建议

按重要性和复杂度排序：

1. **高优先级（核心功能）：**
   - index (索引系统)
   - wal (预写日志)
   - shard (分片管理)
   - eventstore (事件存储)

2. **中优先级（重要支持）：**
   - query (查询引擎)
   - recovery (恢复系统)
   - compaction (压缩)
   - cache (缓存)

3. **低优先级（辅助功能）：**
   - config (配置)
   - metrics (指标)
   - types (类型定义)
   - errors (错误处理)
